/*
Hybrid Dropdown JavaScript plugin insprired from an original idea by Sandrina Pereira (twitter:@a_sandrina_p)
Version: 2.1.0
Authors: Aurovrata Venet
Twitter: @aurovrata
GitHub: https://github.com/aurovrata/hybrid-html-dropdown
*/

//custom error.
class HybridDDError extends Error {
  constructor(message) {
    super(message);
    this.name = 'HybridDropdownError';
  }
}
// global module creation
(function (factory) {
  typeof define === 'function' && define.amd
    ? define(factory)
    : typeof exports === 'object'
      ? (module.exports = factory())
      : factory()
})(function () { //hybrid-select factory.
	let _window = typeof window !== 'undefined' ? window : this;
	let HybridDropdown = (_window.HybridDropdown = function (elm, settings) {
    //verify we have an element and a source
    if(!elm || !(elm instanceof Element)){
      throw new HybridDDError("HybridDropdown requires a DOM element to intialise.");
    }
    if(elm.classList.contains('hybridddised') && elm._hybriddd){
      console.log('WARNING: attempting instantiate element already converted to Hybrid Dropdown');
      return elm._hybriddd;
    }
    if(elm.classList.contains('hybrid-dropdown')){
      console.log('WARNING: attempting instantiate Hybrid Dropdown element.');
      return elm;
    }

    let _ = this, //main hybrid object.
      lim=1, cb=true, //selection limit / whether to have visible checkboxes on options.
      tabIdx = elm.getAttribute('tabindex');
    _.isDS = false; //flag if dropdown built using json dataset
    _.hasDd = true ; //flag is field has dropdown menu.
    cnfg = Object.assign({}, elm.dataset); //get any initial settings.

    ['class','id','name'].forEach(a=>{
      if(elm.hasAttribute(a)){
        let opt = 'field'+a.charAt(0).toUpperCase() + a.slice(1);
        cnfg[opt] = elm.getAttribute(a);
        switch(a){
          case 'name':
            elm.removeAttribute(a);
            elm.setAttribute(`data-hdd-${a}`,cnfg[opt]); //retain information on initial element.
        }
      }
    });
    switch(true){
      case elm.nodeName === "SELECT": //select field source.
        if(elm.multiple) lim=-1;
        // elm.style="visibility:hidden"; //hide the origial select field.
        cb = false; //checkboxes
        if(!cnfg.fieldName && cnfg.fieldId) cnfg.fieldName = cnfg.fieldId;
        if(cnfg.fieldId) cnfg.fieldId += '-hdd';
        break;
      default:
        _.isDS = true;// dateset source.
        if(!settings['dataSet']){ //json object parsed or in HTML
          let is = elm.querySelector('script');
          if(is){
            try{
              cnfg['dataSet'] = JSON.parse(elm.querySelector('script').innerHTML);
            }catch(se){
              console.log(se.name+":"+se.message);
              console.log("HybridDropdown ERROR: missing or malformed json dataset");
            }
          }else{
            console.log("HybridDropdown ERROR: missing json dataset");
            cnfg['dataSet'] = null;
          }
        }
        // if(!cnfg.fieldId && cnfg['fieldName']) cnfg['fieldId'] = cnfg['fieldName'];
        if(!cnfg.fieldName && cnfg.fieldId) cnfg.fieldName = cnfg.fieldId; //setup default fieldName
        elm.classList.add('hybriddd-custom'); //flag the element as custom.
        break;
    }
    //expose object in original DOM element.
    elm._hybriddd = _;
    _.el = elm; //keep original element reference.
    _.el.classList.add('hybridddised'); //flag the element as converted.
    // let pl = _.el.closest('label');
    // merge user setting with defaults
    Object.keys(cnfg).forEach(k=>{
      switch(k){
        case 'limitSelection':
          cnfg[k] = parseInt(cnfg[k]);
          break;
        case 'treeView':
        case 'negative':
        case 'colourise':
        case 'multiple':
        case 'checkboxes':
          cnfg[k] = (cnfg[k] == 'true');
          break;
        case 'selectedValues':
          if(cnfg[k].indexOf('[')>=0) cnfg[k] = JSON.parse(cnfg[k]);
          else cnfg[k] = [cnfg[k]];
          break;
      }
    });
    _.opt = Object.assign(
      {},//initial target.
      {
        dropdown: 'vertical',
        limitSelection:lim, //default 1, -1 for multiple, or userset.
        optionLabel: function(label){
          return '<span>'+label+'</span>';
        },
        selectedLabel: function(s){
          let k =  Object.keys(s);
          return s[k[0]]+ ((k.length>1)?'<span>[...]</span>':'');
        },
        defaultText:'---',
        treeView:false,
        treeGlue:'/',
        fieldName: 'hybriddd', //we need a field name.
        backgroundColor:'',
        color:'',
        negative: false,
        colourise: true,
        checkboxes: cb,
        tabIndex:tabIdx?tabIdx:0,
        listOption: null,
        selectedValues:[],
        fieldId:'',
        fieldClass:''
      }, //default settings.
      settings, //user settings.
      cnfg //element data attribtues, precede over others to allow HTML script overrides.
    );
    if('none' == _.opt.dropdown) _.hasDd = false;
    //make sure selectedValues are strings...
    if(_.opt.selectedValues.length>0) _.opt.selectedValues = _.opt.selectedValues.map(String);
    //nake sure we have proper functions
    ['selectedLabel','optionLabel'].forEach(s=>{
      if(!_.opt[s] || !(_.opt[s] instanceof Function) || 1!=_.opt[s].length){
        throw new HybridDDError(`${s} setting must be a function with 1 argument.`);
      }
    });
    if(_.opt.listOption ){  //check we have a function.
      if( !(_.opt.listOption instanceof Function) || 2!=_.opt.listOption.length ){
        throw new HybridDDError("listOption setting must be a function with 2 arguments.");
      }
    }
    if( (_.opt.treeView || _.opt.multiple) && _.opt.limitSelection<2) _.opt.limitSelection=-1; //by default
    _.multi = (_.opt.limitSelection !=1); //flag multi select field.
    //check if we have a field name.
    // if(!_.opt.fieldId) _.opt.fieldId = _.opt.fieldName;
    if(_.multi && _.opt.fieldName && _.opt.fieldName.indexOf('[]')<0) _.opt.fieldName +='[]';

    //initialise the hybrid-dd.
    _.init(true, true, true);
    return _;
	});
  /* Prototyping some methods for HybridDropdown object */
  let hsProtype = HybridDropdown.prototype;
  //initialisation function.
  hsProtype.init = function(init, build, paint){
    let _ = this;

    if(init) {
      _.hdd = null; //dropdown container.
      if(_.isDS){
        _.hdd=_.el;
        if(!_.el.hasAttribute('tabindex')) _.hdd.setAttribute('tabindex',_.opt.tabIndex);
      }else{
        _.hdd = document.createElement('div');
        _.el.parentNode.insertBefore(_.hdd, _.el.nextSibling);
        _.hdd.style['margin-left']='-'+_.el.getBoundingClientRect()['width']+'px';
        _.hdd.setAttribute('tabindex',_.opt.tabIndex);
      }
      _.hdd.setAttribute('id',_.opt.fieldId);
      let pl = _.el.closest('label');
      if(pl) pl.setAttribute('for',_.opt.fieldId);
      _.hdd.setAttribute('class',_.opt.fieldClass);
      _.hdd.classList.add('hybrid-dropdown');
      // _.hdd.setAttribute('aria-hidden', true);//hide from readers.
      _.hdd.selected = document.createElement('div');
      _.hdd.appendChild(_.hdd.selected);
      _.hdd.selected.classList.add('hybriddd-selected');
      _.hdd.listwrap = document.createElement('div');
      _.hdd.appendChild(_.hdd.listwrap);
      _.hdd.ddlist = document.createElement('ul');
      _.hdd.listwrap.appendChild(_.hdd.ddlist);
      _.hdd.listwrap.classList.add('hybriddd-wrapper');
      _.hdd.ddlist.classList.add('hybriddd-options');
      _.listenForBulk = false;
      _.listenModClick = false;
      _.hdd.classList.add('hybriddd-'+_.opt.dropdown);
    }
    //build list of options.
    if(build){
      let opts = null;
      _.hdd.options = {};
      _.hindex=[]; //hover indexes used to track shiftkey + drag events.
      _.sindex=[]; //initial index of selected option.
      _.value={}; //initial value.
      try{
        if(_.isDS){
          _.hdd.classList.add('hybriddd-custom');
          if(_.opt.dataSet){
            opts = _.buildOptionList(Object.entries(_.opt.dataSet),0);
          }else{
            _.hdd.selected.innerHTML = "<em>json error</em>";
            opts = [];
          }
        }
        else opts = _.buildOptionList(_.el.children,0);
        _.hdd.ddlist.replaceChildren(...opts);
      }catch(err){
        if(err instanceof HybridDDError){
          console.log(err.name+":"+err.message);
          _.hdd.selected.innerHTML = "<em>json error</em>";
        }else throw err;
      }
    }

    if(init){
      //bind some events....
      if(!_.isDS){
        //listen for 'change' on the original select.
        _.event(_.el,'add',{
          change: _.updateFromOriginal.bind(_),
          focus: _.originalElementFocus.bind(_)
        });
      }
      //listen for input field changes.
      _.change = _.inputChange.bind(_);
      _.event(_.hdd.ddlist,'add',{
        change: _.change
      });
      if(_.hasDd){//listen for click and down arrow events.
        _.open = _.openSelect.bind(_);
        _.event(_.hdd, 'add',{
          click: _.open
        });
      }
      //listen for form reset.
      let f = _.el.closest('form');
      if(f){
        _.event(f,'add',{
          reset:_.reset.bind(_)
        })
      }
      if(_.hasDd){//create a close function.
        _.close = _.closeSelect.bind(_, true);
      }
      //blur function
      _.blur = _.blurField.bind(_);
      //trach hover for multi fields.
      _.hover = _.optionHover.bind(_);
      //navigate with keys.
      _.keyNav = _.keyboardNavigate.bind(_);
      //listen for spacebar/arrow keys used for navigation.
      _.event(_.hdd,'add',{
        keydown:_.keyNav
      });
      //refresh fn.
      _.refresh = _.refreshHybrid.bind(_);
      //ctrl + click event handling.
      _.modClick = _.optionModClick.bind(_);
      //fire init event.
      _.emit('hybrid-dd-init');
    }
    //styling.
    if(_.opt.checkboxes)_.hdd.classList.add('show-cb');
    if(paint) _.colourise();
  }
  //set colour for dd elements.
  hsProtype.colourise = function(){
    let _ = this, globalStyle=false;

    if(!_.opt.colourise) return;

    if(!_window['hdd'] && (!_.opt.backgroundColor || !_.opt.color)){
      let found=false, p=_.hdd, s;
      _window.hdd={};
      while(!found && p){
        s = _window.getComputedStyle( p, null);
        if(!_window.hdd['bgColor'] && !_.opt.backgroundColor){
          switch(s['background-color']){ //bg colour;
            case 'transparent':
            case '':
            case 'rgba(0, 0, 0, 0)':
              p=p.parentElement;
              break;
            default:
              _window.hdd['bgColor'] = s['background-color'];
          }
        }
        if(!_window.hdd['color'] && !_.opt.color){
          switch(s['color']){ //bg colour;
            case 'transparent':
            case '':
            case 'rgba(0, 0, 0, 0)':
              p=p.parentElement;
              break;
            default:
              _window.hdd['color'] = s['color'];
          }
        }
        if(_window.hdd['bgColor'] && _window.hdd['color']) found=true;
        globalStyle = true;
      }
      if(!found){ //set to default.
        if(!_window.hdd['color']) _window.hdd['color'] = '#fff';
        if(_window.hdd['bgColor']) _window.hdd['bgColor'] = '#5d5d5d';
      }
    }
    //give pred to object settings.
    let bg = _.opt.backgroundColor ? _.opt.backgroundColor:_window.hdd['bgColor'],
    cl =_.opt.color ? _.opt.color:_window.hdd['color'];

    _.hdd.style['background-color'] = _.opt.negative? cl:bg;
    _.hdd.style['color'] = _.opt.negative? bg:cl;

    if(globalStyle){
      let active = document.createElement('style');
      active.setAttribute('id','hybriddd-colours');
      active.type = "text/css";
      active.innerText = `.hybriddd-option.active > label:hover,.hybriddd-option.hover > label,.hybriddd-option \
      > label:hover{color:${bg};background-color:${cl}}:hover > input:checked+.hybridddcb::before \
      {background-color:${bg}}ul.hybriddd-options::-webkit-scrollbar-track {background:${bg}} \
      ul.hybriddd-options::-webkit-scrollbar-thumb, ul.hybriddd-options::-webkit-scrollbar{background:${cl}} \
      ul.hybriddd-options{scrollbar-color:${cl} ${bg}}`;
      document.head.appendChild(active);
    }
    if(_.opt.backgroundColor || _.opt.color || _.opt.negative){
      if(_.opt.negative){
        let tmp = bg;
        bg = cl;
        cl = tmp;
      }
      let active = document.createElement("style"), id = _.hdd.getAttribute('id');
      active.setAttribute('id',id+'-css');
      active.type = "text/css";
      active.innerText = `#${id} .hybriddd-option.active > label:hover,#${id} .hybriddd-option.hover > label,#${id} \
      .hybriddd-option > label:hover{color:${bg};background-color:${cl}}#${id} :hover > input:checked + .hybridddl > \
      .hybridddcb::before {color:${cl}} #${id} ul.hybriddd-options::-webkit-scrollbar-track {background:${bg}} \
      #${id} ul.hybriddd-options::-webkit-scrollbar-thumb,#${id} ul.hybriddd-options::-webkit-scrollbar{background:${cl}} \
      #${id} ul.hybriddd-options{scrollbar-color:${cl} ${bg};`;
      document.head.appendChild(active);
    }
  }
  //method to refresh an existing HybridDropdown object.
  hsProtype.refreshHybrid = function(settings={}){
    let _ = this, build = true, paint = false;
    if( settings.hasOwnProperty('negative')  || settings.hasOwnProperty('colourise') || settings['color'] || settings['backgroundColor']){
      paint = true;
      let id = _.el.getAttribute('id');
      let st = document.querySelector('style#'+id+'-css');
      if(st) st.remove();
    }
    if( settings['listOption'] ){
      // build = true; //keep build by default
      if( !(settings.listOption instanceof Function && 2==settings.listOption.length) ){
        console.log("Hybriddd refresh error: listOption setting must be a function with 2 arguments.");
        settings['listOption'] = null; //reset.
      }
    }
    _.opt = Object.assign({}, _.opt, settings);
    _.init(false, build, paint); //invole init function but do not initialise.
  }
  //method to initialise options.
  hsProtype.buildOptionList = function(list,p, tree=''){
    let _ = this,
      opts=[],
      t=(_.multi) ? 'checkbox':'radio',
      fname = (_.opt.fieldName ? ' name="'+_.opt.fieldName+'"':'');

    [].forEach.call(list,(o,i) => {
      //TODO: check if o is optgrp, and loop over.
      if(_.opt.listOption && _.opt.listOption(o,i) !== true) return;

      let hso = document.createElement('li'),
       isGroup = false, isSelected = false, hasChildren = false,
       lbl, val, kids=[], icl='', checked='';
      if(_.isDS){
        lbl = o[0];
        val=null;
        switch(true){
          case o[1] instanceof Object && !o[1].length: //object but not array.
          case 0===p && o[1] instanceof Array:
            hasChildren = isGroup = true;
            if(o[1]['label']){
              isGroup = false;
              val = o[0];
              icl = 'hybridddis';
              lbl = _.opt.optionLabel(o[1]['label']);
              kids = Object.entries(o[1]);
              kids.splice(Object.keys(o[1]).indexOf('label'),1); //remove label
              hasChildren = (kids.length>0);
              isSelected = _.opt.selectedValues.indexOf(val) >=0;
            }else kids = Object.entries(o[1]);
            break;
          default:
            icl = 'hybridddis';
            val = o[0];
            lbl = _.opt.optionLabel(o[1]);
            isSelected = _.opt.selectedValues.indexOf(val) >=0;
        }
      }else{
        switch(o.nodeName){
          case 'OPTGROUP':
            hasChildren = isGroup = true;
            lbl = o.label;
            kids = o.children;
            break;
          default:
            icl = 'hybridddin'; //to ignore input when tabbed.
            lbl = o.text;
            val = o.value;
            isSelected = o.selected;
        }
      }
      switch(isGroup){
        case true:
          hso.innerHTML ='<span>'+lbl+'</span>';
          hso.classList.add('hybriddd-group');
          break;
        default:
          checked='';
          if(isSelected){
            _.value[val] = lbl;
            _.sindex.push(val);
            checked = ' checked';
          }
          //preserve select options attributes.
          // for(let k in o.dataset) hso.dataset[k]=o.dataset[k];
          hso.setAttribute('tabindex','-1');
          hso.innerHTML = `<label class="hybriddd-l${p}"><input tabindex="-1" class="${icl}" type="${t}" value="${tree}${val}" ${fname}${checked}/><span class="hybridddcb"></span><span class="hybridddl">${lbl}</span></label>`;
          hso.classList.value = 'hybriddd-option' + (isSelected ? ' active':'');
          if(!_.isDS) hso.classList.value += ` ${o.classList.value}`; // + (o.value!=''?'hybriddd-'+o.value:'');
          //make sure not duplicate value.
          if(_.hdd.options[(tree+val)]) throw new HybridDDError("Option list has duplicate value: "+val);
          _.hdd.options[(tree+val)] = hso;
          break;
      }
      if(hasChildren){
        if(_.opt.treeView && val) tree+=val+_.opt.treeGlue;
        let cos = _.buildOptionList(kids, p+1, tree),
          ul = document.createElement('ul');
        ul.replaceChildren(...cos);
        hso.appendChild(ul);
      }
      opts[opts.length] = hso;
    });
    if(0==p){ //first level end.
      if(_.empty()) _.reset();
      //make sure empty value does not cohabit with others.
      let vs = Object.keys(_.value);
      if( vs.length>1 && vs.indexOf('')>=0) delete _.value[''];
      _.hdd.selected.innerHTML = _.opt.selectedLabel(_.value);
    }
    return opts;
  }
  //check if values are empty.
  hsProtype.empty = function(){
    let _ = this;
    for(let k in _.value) return false;
    return true;
  }
  //reset the default value of the field.
  hsProtype.reset = function(){
    let _ = this;
    _.sindex = [];
    _.value = {};
    // _.clearClass('hover');
    _.clearClass('active');
    if(_.hdd.options['']){
      _.hdd.options[''].classList.add('active');
      _.value['']=_.hdd.options[''].querySelector('.hybridddl').innerHTML;
      _.hdd.options[''].querySelector('input').checked=true;
      _.sindex.push('');
    }else _.value[''] = _.opt.defaultText;
    _.hdd.selected.innerHTML = _.opt.selectedLabel(_.value);
  }
  //method to add event listeners.
  hsProtype.event = function (ele, type, args) {
    var eventHandler = ele[type + 'EventListener'].bind(ele)
    Object.keys(args).forEach(function (k) {
      if(['mouseenter','mouseleave'].indexOf(k)>=0)   eventHandler(k, args[k],true);
      else eventHandler(k, args[k])
    })
  }
  //update from original
  hsProtype.updateFromOriginal = function(){
    let _ = this, vs=[];
    if(_.isDS) return;
    if(_.multi){
      let skipUpdate = true;
      for(let i=0; i<_.el.selectedOptions.length; i++){
        if(!(_.el.selectedOptions.item(i).value in _.value) ){
          vs.push(_.el.selectedOptions.item(i).value);
          skipUpdate=false;
        }
      }
      if(skipUpdate) return;
    }else if(_.el.value in _.value) return; //not need to update.
    else vs.push(_.el.value);

    _.addValue(vs, false);
  }
  //trigger events.
  hsProtype.emit = function (name, arg) {
    let _ = this,
      e = new _window.CustomEvent(name, {
      bubbles: true,
      detail: arg
    })
    _.el.dispatchEvent(e)
  }
  //focus hybrid select when the original select is tabbed into.
  hsProtype.originalElementFocus = function(){
    let _ = this;
    if(!_.isDS){
      if(_.el.disabled) return;
      _.el.blur();
    }
    _.hdd.focus({preventScroll:true});
    _.hdd.classList.add('focus');
    //cancel window scrolling on space bar.
    _.event(document,'add',{
      click: _.blur
    })
  }
  //TODO: onblur, clean up window keydown event.
  hsProtype.blurField = function(){
    let _ = this;
    _.hdd.classList.remove('focus');
    // _.event(_.hdd,'remove',{
    //   keydown:_.keyNav
    // })
  }
  //find next hybrid-option index.
  hsProtype.nextOption = function(cur){
    let _ = this,
      keys = Object.keys(_.hdd.options),
      next = (cur.length>0?keys.indexOf(cur[cur.length-1]):-1);
    if(next < keys.length) next++;
    if(next === keys.length) next=0;//end of list.
    return keys[next];
  }
  //find prev option.
  hsProtype.prevOption = function(cur){
    let _ = this,
      keys = Object.keys(_.hdd.options),
      prev = (cur.length>0?keys.indexOf(cur[0]):keys.length);
    if(prev >= 0 ) prev--;
    if(prev < 0) prev =keys.length-1;//end of list.
    return keys[prev];
  }
  //key navigation.
  hsProtype.keyboardNavigate = function(){
    let _ = this, e = arguments[0], v, bdl,bdi;
    if(_.el.disabled) return;
    if(e && e.keyCode){
      e.preventDefault(); //stop page scroll.
      switch(true){
        case 40==e.keyCode && 'keydown' == e.type: //down arrow.
          if(_.hdd.classList.contains('active')){ //list is open, change hover option
            if(_.hindex.length>0 && !_.multi || !e.shiftKey) _.clearClass('hover'); //toggle class
             v = _.nextOption(_.hindex);
            _.hdd.options[v].classList.add('hover');
            _.scroll(v, 'down');
            if(_.multi && e.shiftKey){
              _.hindex.push(v);
              if(_.opt.limitSelection>0) _.hindex = _.hindex.slice(-1*_.opt.limitSelection);
            }else _.hindex[0] = v;
          }else{ //change select value
            if(1==_.opt.limitSelection){ //select the next value.
              v = _.nextOption(_.sindex);
              _.toggleValue([v], true);
            }else if(_.hasDd){ //open the dropdown.
              _.hdd.classList.remove('focus');
              _.open();
            }
          }
          break;
        case 38==e.keyCode && 'keydown' == e.type: //up arrow.
          if(_.hdd.classList.contains('active')){ //list is open, change hover option
            if(_.hindex.length>0 && !_.multi || !e.shiftKey) _.clearClass('hover');
            v = _.prevOption(_.hindex);
            _.hdd.options[v].classList.add('hover');
            _.scroll(v,'up');
            if(_.multi && e.shiftKey){
              _.hindex.push(v);
              if(_.opt.limitSelection>0) _.hindex = _.hindex.slice(-1*_.opt.limitSelection);
            }else _.hindex[0] = v;
          }else{ //change select value
            if(1==_.opt.limitSelection){ //select the next value.
              let v = _.prevOption(_.sindex);
              _.toggleValue([v], true);
            }else if(_.hasDd){ //open the dropdown.
              _.hdd.classList.remove('focus');
              _.open();
            }
          }
          break;
        case 13==e.keyCode && 'keydown' == e.type: //enter.
        case 32==e.keyCode && 'keydown' == e.type: //spacebar.
          if(_.hdd.classList.contains('active') === false && _.hasDd){//open the list.
            _.hdd.classList.remove('focus');
            _.open();
          }else{
            if(_.hindex.length>0) _.toggleValue(_.hindex, true);
            if(_.hasDd){
              _.closeSelect(false);
              _.hdd.classList.add('focus');
            }
          }
          break;
        case 27==e.keyCode && 'keydown' == e.type: //esc
          if(_.hdd.classList.contains('active')) _.closeSelect(false); //close list if open
          _.blurField(); //blur.
          break;
        case 9==e.keyCode && 'keydown' == e.type: //tab key, navigate to next field.
          if(_.hdd.classList.contains('active')) _.closeSelect(false); //close list if open
          _.blurField(); //blur.

          //check if field has tab index.
          let tidx = _.el.getAttribute('tabindex')*1.0,
            form = _.el.closest('form'),
            next, cur;

          if(form === null) form = document;
          if(tidx != null && tidx != ''){
            tidx +=1;
            next = form.querySelector('[tabindex="'+tidx+'"]');
          }else if(form !== document){ //find current field sibling.
            cur = _.el;
            if(_.isDS){
              cur = Object.keys(_.hdd.options);
              tidx = cur[cur.length-1]; //last key.
              cur = _.hdd.options[tidx].querySelector('input');
            }
            for(tidx in form.elements){
              if(form.elements[tidx] !== cur) continue; //move to next element.

              do{
                tidx++
              }while(tidx<form.elements.length && form.elements[tidx].classList.contains('hybridddin'));
              if(form.elements.length==tidx) tidx=0;
              if(form.elements[tidx].classList.contains('hybridddis')){
                next = form.elements[tidx].closest('.hybriddd-custom');
              }else{
                next = form.elements[tidx];
              }
              break;
            }
          }
          if(null!=next){
            switch(true){
              case next.classList.contains('hybriddd-custom'):
                next._hybriddd.originalElementFocus();
                break;
              case next.type === 'text':
                next.select();
                break;
              default:
                next.focus();
                break;
            }
          }
          break;
        case 16==e.keyCode && 'keydown' == e.type: //shift.
          if(_.multi && _.hdd.classList.contains('active')){
            //listen for drag event.
            let o = e.originalTarget;
            if(!o) o = e.target;
            if(!o.classList.contains('hybriddd-option')) o = o.closest('.hybriddd-option');
            if(o)_.hindex = [o.querySelector('input').value];
            if(!_.listenForBulk){
              _.event(_.hdd.ddlist,'add',{
                mouseenter:_.hover,
                mouseleave:_.hover,
                click:_.modClick,
                'hybrid-ddi-change':_.change
              });
              _.listenForBulk = true;
              _.listenModClick = true;
            }
          }
          break;
        case 16==e.keyCode && 'keyup' == e.type:
          if(_.listenForBulk){
            _.event(_.hdd.ddlist,'remove',{
              mouseenter:_.hover,
              mouseleave:_.hover,
              click:_.modClick,
              'hybrid-ddi-change':_.change
            });
            _.listenForBulk = false;
            _.listenModClick = false;
          }
          break;
        case 17==e.keyCode && 'keydown' == e.type: //ctrl.
          if(!_.listenModClick && _.multi){
            _.event(_.hdd.ddlist,'add',{
              click:_.modClick,
              'hybrid-ddi-change':_.change
            });
            _.listenModClick = true;
          }
          break;
        case 17==e.keyCode && 'keyup' == e.type: //ctrl.
          if(_.listenModClick){
            _.event(_.hdd.ddlist,'remove',{
              click:_.modClick,
              'hybrid-ddi-change':_.change
            });
            _.listenModClick = false;
          }
          break;
      }
    }
  }
  //listen for ctrl|shift + click on multiple dropdown.
  hsProtype.optionModClick = function(e){
    let _ = this, o, i;
    if(e && e.target){ //target only label clicks as they both register on webkit + gekho engines.
      if(!e.ctrlKey && !e.shiftKey){ //ctrl keyup  does not fire after a ctrl+click.
        if(_.listenModClick){
          _.event(_.hdd.ddlist,'remove',{
            click:_.modClick,
            'hybrid-ddi-change':_.change
          });
          _.listenModClick = false;
        }
        if(_.listenForBulk){
          _.event(_.hdd.ddlist,'remove',{
            mouseenter:_.hover,
            mouseleave:_.hover,
          });
          _.listenForBulk = false;
        }
        return;
      }
      o = e.target.closest('.hybriddd-option');
      if(o){
        i = o.querySelector('input');
        i.checked = (!i.checked);
        i.dispatchEvent(new Event('hybrid-ddi-change', { 'bubbles': true}));
        i.classList.add('mod-ctrl');
      }
    }
  }
  //scroll items into view.
  hsProtype.scroll = function(v,dir='up'){
    let _ = this, i = _.hdd.options[v].querySelector('label'),
    bdi = i.getBoundingClientRect(),
    bdl = _.hdd.ddlist.getBoundingClientRect();
    if(bdi.top < bdl.top || bdi.bottom > bdl.bottom){
      switch(dir){
        case 'up':
          if(bdl.top > bdi.top) _.hdd.ddlist.scrollTop -= bdi.height;
          else if(bdl.bottom < bdi.bottom) _.hdd.ddlist.scrollTop=bdi.bottom - bdl.bottom;
          break;
        case 'down':
          if(bdl.bottom < bdi.bottom) _.hdd.ddlist.scrollTop += bdi.height;
          else if(bdl.top > bdi.top) _.hdd.ddlist.scrollTop=0;
          break;
      }
    }
  }
  //options input changed.
  hsProtype.inputChange = function(){
    let _ = this, e = arguments[0], v=[], isCtrl = false;
    if(e && e.target){
      isCtrl = e.target.classList.contains('mod-ctrl');
      if('change'==e.type && isCtrl){
        e.target.classList.remove('mod-ctrl')
        return false;
      }
      if(_.hindex.length>0) v = [..._.hindex]; //shift + scroll.

      if(e.target.checked && ''==e.target.value){ //clear values.
        if(!isCtrl) _.removeValue([..._.sindex], true); //use array copy else buggy.
      }else if(_.opt.treeView && (_.opt.limitSelection < 0 || _.opt.limitSelection > _.sindex.length)){
        //toggle all children
        let ai,
          i,
          start = true,
          pl = e.target.closest('.hybriddd-option'),
          ci = pl.querySelectorAll("input");

        for (i of ci.values()) {
          i.checked = e.target.checked;
          if(!isCtrl){
            if(e.target.checked) v.push(i.value);
            else _.removeValue([i.value]);
          }
          i.closest('.hybriddd-option').classList.remove("partial");
        }

        //check parent branch.
        while (pl) {
          i = pl.querySelector("input");
          if (!start && !i.checked &&
            (pl.querySelectorAll("label input").length - pl.querySelectorAll("label input:checked").length)==1
          ) {
            i.checked = true;
            v.push(i.value);
            pl.classList.remove("partial");
          }
          ci = pl.querySelectorAll("input:checked");
          ai = pl.querySelectorAll("input");
          if (i.checked && ci.length == 1 && ai.length > 1) {
            //special case, all children unchecked.
            pl.classList.remove("partial");
            i.checked = false;
            if(!isCtrl) _.removeValue([i.value]);
          } else if (ci.length > 0 && ai.length != ci.length) {
            pl.classList.add("partial");
            if(!isCtrl) _.removeValue([i.value]);
          } else pl.classList.remove("partial");
          pl = pl.parentNode.closest('.hybriddd-option');
          start = false;
        }
        if(!isCtrl) _.addValue(v, true);
      }else{ //just add the current value.
        if(!isCtrl) {
          v.push(e.target.value);
          if(e.target.checked) _.addValue(v, true);
          else _.removeValue(v, true);
        }
      }
      switch(true){
        case 'hybrid-ddi-change'== e.type:
        case e.shiftKey && e.shiftKey==true:
          break;
        default:
          _.closeSelect(false);
          break;
      }
    }
  }
  //toggle values that are hoghlighted.
  hsProtype.toggleValue = function(varr, emit){
    let _ = this;
    //for now simply add/remove based on first value.
    if(_.hdd.options[varr[0]].querySelector('input').checked) _.removeValue(varr, emit);
    else _.addValue(varr, emit);
  }
  //add value.
  hsProtype.addValue = function(varr, emit=false){
    let _ = this;
    switch(_.opt.limitSelection){
      case 1:
        if(_.sindex.length>0) _.hdd.options[_.sindex[0]].classList.remove('active');
        _.sindex=varr;
        break;
      default:
        if(_.sindex.length==1 && _.sindex[0].length==0){
          _.hdd.options[''].classList.remove('active');
          _.hdd.options[''].querySelector('input').checked=false;
          _.sindex=varr;
        }else _.sindex = _.sindex.concat(varr);
        if(_.opt.limitSelection>0){
          for(let j = _.opt.limitSelection; j<_.sindex.length;j++){
            _.hdd.options[_.sindex[j]].querySelector('input').checked=false;
          }
          _.sindex = _.sindex.slice(0,_.opt.limitSelection);
        }
        _.clearClass('hover');
        _.hindex=[];
        break;
    }
    _.value={};
    _.sindex.forEach(v=>{
      _.value[v]=_.hdd.options[v].querySelector('.hybridddl').innerHTML;
      _.hdd.options[v].querySelector('input').checked=true;
      _.hdd.options[v].classList.add('active');
    });
    if(_.empty()) _.reset();
    if(!_.isDS) _.updateOriginal();
    //update selected value label.
    _.hdd.selected.innerHTML = _.opt.selectedLabel(_.value);
    if(emit) _.emit('change');
  }
  //remove value.
  hsProtype.removeValue = function(varr, emit=false){
    let _ = this,idx;
    varr.forEach(v=>{
      _.hdd.options[v].classList.remove('active');
      _.hdd.options[v].querySelector('input').checked=false;
      idx = _.sindex.indexOf(v);
      if(idx >=0){
        _.sindex.splice(idx,1);
        delete _.value[v];
      }
    });
    if(_.sindex.length==0){ //reset to default.
      if(_.hdd.options['']){
        _.sindex=[''];
        _.value={'':_.hdd.options[''].querySelector('.hybridddl').innerHTML};
        _.hdd.options[''].querySelector('input').checked=true;
        _.hdd.options[''].classList.add('active');
      }else _.value={'': _.opt.defaultText};
    }
    if(_.empty()) _.reset();
    if(!_.isDS) _.updateOriginal();
    _.hdd.selected.innerHTML = _.opt.selectedLabel(_.value);
    if(emit) _.emit('change');
  }
  //method to update the hybrid select value.
  hsProtype.updateOriginal = function(){
    let _ = this;
    Object.keys(_.value).forEach(v=>{
      _.el.selectedIndex = -1;
      _.el.querySelector('option[value="'+v+'"]').selected=true;
    });
  }
  //function to flag options being hovered.
  hsProtype.optionHover = function(){
    let _ = this, v, o,
      e = arguments[0];
    if(!e.shiftKey){
      if(_.hindex.length>0){
        _.clearClass('hover');
        _.hindex=[];
      }
      return; //track shift mouseenter events only.
    }
    if(e.target.classList.contains('hybriddd-option')) o = e.target;
    else o= e.target.closest('.hybriddd-option');
    if(o) {
      v = o.querySelector('input').value;
      switch(e.type){
        case 'mouseleave':
          _.event(_.hdd.ddlist, 'remove',{
            mouseleave: _.hover
          });
          if(v) _.hindex=[v];
          break;
        case 'mouseenter':
          if(_.hindex.includes(v)){
            v =_.hindex[(_.hindex.length-1)]; //toggle last inserted idx.
            _.hindex =_.hindex.slice(0,-1);
          }else if(v) _.hindex.push(v);
          if(_.opt.limitSelection>0) _.hindex = _.hindex.slice(0,_.opt.limitSelection);
          break;
      }
      if(v && !_.sindex.includes(v)) _.hdd.options[v].classList.add('hover');
    }
  }
  //clear class from option.
  hsProtype.clearClass = function(cl){
    let _ = this;
    if('string' == typeof cl && cl.length>0){
      _.hdd.querySelectorAll('.'+cl).forEach(o=>{
        o.classList.remove(cl)
      })
    }
  }
  //open hybrid dropdown.
  hsProtype.openSelect = function(){
    let _= this, e = arguments[0];
    if(_.el.disabled) return;
    if(e && e.target){ //triggered by event?
      if(e.target.classList.contains('hybriddd-options') || e.target.closest('.hybriddd-options')){
        return;  // bubbling selection
      }
      e.stopPropagation();
      _.emit('hybrid-dd-'+e.type); //notify other hdd fields that his one is being opened.
    }
    if(_.hdd.classList.contains('active')) {
      _.closeSelect();
      return;
    }
    //set the height of the wrapper for placing it on top.
    _.hdd.listwrap.style.setProperty('--hybriddd-top',_.hdd.offsetHeight+'px');
    _.hdd.classList.add('active');
    //adjust width of dropdown.
    //setup wrapper height and width.
    if(!_.hdd.ddlist.style['min-width']) _.hdd.ddlist.style['min-width']=(_.hdd.ddlist.offsetWidth + 12)+"px";
    if(!_.hdd.listwrap.style['height']){
      _.hdd.listwrap.style['height']=_.hdd.ddlist.offsetHeight+"px";
      _.hdd.listwrap.style['width']="100%";
    }

    //listen for external clicks to close.
    _.event(document, 'add',{
      click: _.close
    });
    //listen for keyup navigation (ctrl/shift key)
    _.event(_.hdd,'add',{
      keyup:_.keyNav
    });
    //close if another hdd field opens.
    _.event(document,'add',{
      'hybrid-dd-click':_.close
    });
  }
  //close hybrid dropdown.
  hsProtype.closeSelect = function(blur){
    let _ = this,
      e = arguments[0],
      e2 = arguments[1]; //click on document
    //if click to select cancel close.
    if(e && e.target && e.target.classList.contains('hybriddd-option')) return;

    if(e2){
      if(e2.target.isSameNode(_.el)) return; //in case original element is clicked
      if(_.multi && (e2.ctrlKey || e2.shiftKey)) return; //multiple select w/ ctrl|shift key
      if(e2.target.parentNode.classList && e2.target.parentNode.classList.contains('hybriddd-group')) return;
      if(e2.target.closest('.hybriddd-option')) return;
    }

    _.hdd.classList.remove('active');
    //reset the option hover index.
    _.clearClass('hover');
    _.hindex = [];
    //stop listening to external clicks.
    _.event(document, 'remove',{
      click: _.close
    });
    _.event(document,'remove',{
      'hybrid-dd-click':_.close
    });
    _.event(_.hdd,'remove',{
      keyup:_.keyNav
    });
    //stop listening for option list mouseenter.
    if(_.listenForBulk){
      _.event(_.hdd.ddlist, 'remove',{
        mouseenter: _.hover
      });
      _.listenForBulk = false;
    }
    if(blur) _.blur(); //remove focus.
  }

	return HybridDropdown;
})
=======
class HybridDDError extends Error{constructor(e){super(e),this.name="HybridDropdownError"}}!function(e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():e()}(function(){let e="undefined"!=typeof window?window:this,t=e.HybridDropdown=function(e,t){if(!(e&&e instanceof Element))throw new HybridDDError("HybridDropdown requires a DOM element to intialise.");if(e.classList.contains("hybridddised")&&e._hybriddd)return console.log("WARNING: attempting instantiate element already converted to Hybrid Dropdown"),e._hybriddd;if(e.classList.contains("hybrid-dropdown"))return console.log("WARNING: attempting instantiate Hybrid Dropdown element."),e;let d=this,i=1,l=!0,o=e.getAttribute("tabindex");switch(d.isDS=!1,cnfg=Object.assign({},e.dataset),["class","id","name"].forEach(t=>{if(e.hasAttribute(t)){let d="field"+t.charAt(0).toUpperCase()+t.slice(1);switch(cnfg[d]=e.getAttribute(t),t){case"name":e.removeAttribute(t)}}}),!0){case"SELECT"===e.nodeName:e.multiple&&(i=-1),l=!1,!cnfg.fieldName&&cnfg.fieldId&&(cnfg.fieldName=cnfg.fieldId),cnfg.fieldId&&(cnfg.fieldId+="-hdd");break;default:if(d.isDS=!0,!t.dataSet){if(e.querySelector("script"))try{cnfg.dataSet=JSON.parse(e.querySelector("script").innerHTML)}catch(e){console.log(e.name+":"+e.message),console.log("HybridDropdown ERROR: missing or malformed json dataset")}else console.log("HybridDropdown ERROR: missing json dataset"),cnfg.dataSet=null}!cnfg.fieldName&&cnfg.fieldId&&(cnfg.fieldName=cnfg.fieldId),e.classList.add("hybriddd-custom")}if(e._hybriddd=d,d.el=e,d.el.classList.add("hybridddised"),Object.keys(cnfg).forEach(e=>{switch(e){case"limitSelection":cnfg[e]=parseInt(cnfg[e]);break;case"treeView":case"negative":case"colourise":case"multiple":case"checkboxes":cnfg[e]="true"==cnfg[e];break;case"selectedValues":cnfg[e].indexOf("[")>=0?cnfg[e]=JSON.parse(cnfg[e]):cnfg[e]=[cnfg[e]]}}),d.opt=Object.assign({},{dropdown:"vertical",limitSelection:i,optionLabel:function(e){return"<span>"+e+"</span>"},selectedLabel:function(e){let t=Object.keys(e);return e[t[0]]+(t.length>1?"<span>[...]</span>":"")},defaultText:"---",treeView:!1,treeGlue:"/",fieldName:"hybriddd",backgroundColor:"",color:"",negative:!1,colourise:!0,checkboxes:l,tabIndex:o||0,listOption:null,selectedValues:[],fieldId:"",fieldClass:""},t,cnfg),d.opt.selectedValues.length>0&&(d.opt.selectedValues=d.opt.selectedValues.map(String)),["selectedLabel","optionLabel"].forEach(e=>{if(!(d.opt[e]&&d.opt[e]instanceof Function&&1==d.opt[e].length))throw new HybridDDError(`${e} setting must be a function with 1 argument.`)}),d.opt.listOption&&(!(d.opt.listOption instanceof Function)||2!=d.opt.listOption.length))throw new HybridDDError("listOption setting must be a function with 2 arguments.");return(d.opt.treeView||d.opt.multiple)&&d.opt.limitSelection<2&&(d.opt.limitSelection=-1),d.multi=1!=d.opt.limitSelection,d.multi&&d.opt.fieldName&&d.opt.fieldName.indexOf("[]")<0&&(d.opt.fieldName+="[]"),d.init(!0,!0,!0),d},d=t.prototype;return d.init=function(e,t,d){let i=this;if(e){i.hdd=null,i.isDS?(i.hdd=i.el,i.el.hasAttribute("tabindex")||i.hdd.setAttribute("tabindex",i.opt.tabIndex)):(i.hdd=document.createElement("div"),i.el.parentNode.insertBefore(i.hdd,i.el.nextSibling),i.hdd.style["margin-left"]="-"+i.el.getBoundingClientRect().width+"px",i.hdd.setAttribute("tabindex",i.opt.tabIndex)),i.hdd.setAttribute("id",i.opt.fieldId);let e=i.el.closest("label");e&&e.setAttribute("for",i.opt.fieldId),i.hdd.setAttribute("class",i.opt.fieldClass),i.hdd.classList.add("hybrid-dropdown"),i.hdd.selected=document.createElement("div"),i.hdd.appendChild(i.hdd.selected),i.hdd.selected.classList.add("hybriddd-selected"),i.hdd.listwrap=document.createElement("div"),i.hdd.appendChild(i.hdd.listwrap),i.hdd.ddlist=document.createElement("ul"),i.hdd.listwrap.appendChild(i.hdd.ddlist),i.hdd.listwrap.classList.add("hybriddd-wrapper"),i.hdd.ddlist.classList.add("hybriddd-options"),i.listenForBulk=!1,i.listenModClick=!1,i.hdd.classList.add("hybriddd-"+i.opt.dropdown)}if(t){let e=null;i.hdd.options={},i.hindex=[],i.sindex=[],i.value={};try{i.isDS?(i.hdd.classList.add("hybriddd-custom"),i.opt.dataSet?e=i.buildOptionList(Object.entries(i.opt.dataSet),0):(i.hdd.selected.innerHTML="<em>json error</em>",e=[])):e=i.buildOptionList(i.el.children,0),i.hdd.ddlist.replaceChildren(...e)}catch(e){if(!(e instanceof HybridDDError))throw e;console.log(e.name+":"+e.message),i.hdd.selected.innerHTML="<em>json error</em>"}}if(e){i.isDS||i.event(i.el,"add",{change:i.updateFromOriginal.bind(i),focus:i.originalElementFocus.bind(i)}),i.change=i.inputChange.bind(i),i.event(i.hdd.ddlist,"add",{change:i.change}),i.open=i.openSelect.bind(i),i.event(i.hdd,"add",{click:i.open});let e=i.el.closest("form");e&&i.event(e,"add",{reset:i.reset.bind(i)}),i.close=i.closeSelect.bind(i,!0),i.blur=i.blurField.bind(i),i.hover=i.optionHover.bind(i),i.keyNav=i.keyboardNavigate.bind(i),i.event(i.hdd,"add",{keydown:i.keyNav}),i.refresh=i.refreshHybrid.bind(i),i.modClick=i.optionModClick.bind(i),i.emit("hybrid-dd-init")}i.opt.checkboxes&&i.hdd.classList.add("show-cb"),d&&i.colourise()},d.colourise=function(){let t=this,d=!1;if(!t.opt.colourise)return;if(!(e.hdd||t.opt.backgroundColor&&t.opt.color)){let i,l=!1,o=t.hdd;for(e.hdd={};!l&&o;){if(i=e.getComputedStyle(o,null),!e.hdd.bgColor&&!t.opt.backgroundColor)switch(i["background-color"]){case"transparent":case"":case"rgba(0, 0, 0, 0)":o=o.parentElement;break;default:e.hdd.bgColor=i["background-color"]}if(!e.hdd.color&&!t.opt.color)switch(i.color){case"transparent":case"":case"rgba(0, 0, 0, 0)":o=o.parentElement;break;default:e.hdd.color=i.color}e.hdd.bgColor&&e.hdd.color&&(l=!0),d=!0}l||(e.hdd.color||(e.hdd.color="#fff"),e.hdd.bgColor&&(e.hdd.bgColor="#5d5d5d"))}let i=t.opt.backgroundColor?t.opt.backgroundColor:e.hdd.bgColor,l=t.opt.color?t.opt.color:e.hdd.color;if(t.hdd.style["background-color"]=t.opt.negative?l:i,t.hdd.style.color=t.opt.negative?i:l,d){let e=document.createElement("style");e.setAttribute("id","hybriddd-colours"),e.type="text/css",e.innerText=`.hybriddd-option.active > label:hover,.hybriddd-option.hover > label,.hybriddd-option       > label:hover{color:${i};background-color:${l}}:hover > input:checked+.hybridddcb::before       {background-color:${i}}ul.hybriddd-options::-webkit-scrollbar-track {background:${i}}       ul.hybriddd-options::-webkit-scrollbar-thumb, ul.hybriddd-options::-webkit-scrollbar{background:${l}}       ul.hybriddd-options{scrollbar-color:${l} ${i}}`,document.head.appendChild(e)}if(t.opt.backgroundColor||t.opt.color||t.opt.negative){if(t.opt.negative){let e=i;i=l,l=e}let e=document.createElement("style"),d=t.hdd.getAttribute("id");e.setAttribute("id",d+"-css"),e.type="text/css",e.innerText=`#${d} .hybriddd-option.active > label:hover,#${d} .hybriddd-option.hover > label,#${d}       .hybriddd-option > label:hover{color:${i};background-color:${l}}#${d} :hover > input:checked + .hybridddl >       .hybridddcb::before {color:${l}} #${d} ul.hybriddd-options::-webkit-scrollbar-track {background:${i}}       #${d} ul.hybriddd-options::-webkit-scrollbar-thumb,#${d} ul.hybriddd-options::-webkit-scrollbar{background:${l}}       #${d} ul.hybriddd-options{scrollbar-color:${l} ${i};`,document.head.appendChild(e)}},d.refreshHybrid=function(e={}){let t=this,d=!1;if(e.hasOwnProperty("negative")||e.hasOwnProperty("colourise")||e.color||e.backgroundColor){d=!0;let e=t.el.getAttribute("id"),i=document.querySelector("style#"+e+"-css");i&&i.remove()}e.listOption&&(e.listOption instanceof Function&&2==e.listOption.length||(console.log("Hybriddd refresh error: listOption setting must be a function with 2 arguments."),e.listOption=null)),t.opt=Object.assign({},t.opt,e),t.init(!1,!0,d)},d.buildOptionList=function(e,t,d=""){let i=this,l=[],o=i.multi?"checkbox":"radio",n=i.opt.fieldName?' name="'+i.opt.fieldName+'"':"";if([].forEach.call(e,(e,s)=>{if(i.opt.listOption&&!0!==i.opt.listOption(e,s))return;let r,c,a=document.createElement("li"),h=!1,u=!1,p=!1,b=[],f="",y="";if(i.isDS)switch(r=e[0],c=null,!0){case e[1]instanceof Object&&!e[1].length:case 0===t&&e[1]instanceof Array:p=h=!0,e[1].label?(h=!1,c=e[0],f="hybridddis",r=i.opt.optionLabel(e[1].label),(b=Object.entries(e[1])).splice(Object.keys(e[1]).indexOf("label"),1),p=b.length>0,u=i.opt.selectedValues.indexOf(c)>=0):b=Object.entries(e[1]);break;default:f="hybridddis",c=e[0],r=i.opt.optionLabel(e[1]),u=i.opt.selectedValues.indexOf(c)>=0}else switch(e.nodeName){case"OPTGROUP":p=h=!0,r=e.label,b=e.children;break;default:f="hybridddin",r=e.text,c=e.value,u=e.selected}switch(h){case!0:a.innerHTML="<span>"+r+"</span>",a.classList.add("hybriddd-group");break;default:if(y="",u&&(i.value[c]=r,i.sindex.push(c),y=" checked"),a.setAttribute("tabindex","-1"),a.innerHTML=`<label class="hybriddd-l${t}"><input tabindex="-1" class="${f}" type="${o}" value="${d}${c}" ${n}${y}/><span class="hybridddcb"></span><span class="hybridddl">${r}</span></label>`,a.classList.value="hybriddd-option"+(u?" active":""),i.isDS||(a.classList.value+=` ${e.classList.value}`),i.hdd.options[d+c])throw new HybridDDError("Option list has duplicate value: "+c);i.hdd.options[d+c]=a}if(p){i.opt.treeView&&c&&(d+=c+i.opt.treeGlue);let e=i.buildOptionList(b,t+1,d),l=document.createElement("ul");l.replaceChildren(...e),a.appendChild(l)}l[l.length]=a}),0==t){i.empty()&&i.reset();let e=Object.keys(i.value);e.length>1&&e.indexOf("")>=0&&delete i.value[""],i.hdd.selected.innerHTML=i.opt.selectedLabel(i.value)}return l},d.empty=function(){let e=this;for(let t in e.value)return!1;return!0},d.reset=function(){let e=this;e.sindex=[],e.value={},e.clearClass("active"),e.hdd.options[""]?(e.hdd.options[""].classList.add("active"),e.value[""]=e.hdd.options[""].querySelector(".hybridddl").innerHTML,e.hdd.options[""].querySelector("input").checked=!0,e.sindex.push("")):e.value[""]=e.opt.defaultText,e.hdd.selected.innerHTML=e.opt.selectedLabel(e.value)},d.event=function(e,t,d){var i=e[t+"EventListener"].bind(e);Object.keys(d).forEach(function(e){["mouseenter","mouseleave"].indexOf(e)>=0?i(e,d[e],!0):i(e,d[e])})},d.updateFromOriginal=function(){let e=this,t=[];if(!e.isDS){if(e.multi){let d=!0;for(let i=0;i<e.el.selectedOptions.length;i++)e.el.selectedOptions.item(i).value in e.value||(t.push(e.el.selectedOptions.item(i).value),d=!1);if(d)return}else{if(e.el.value in e.value)return;t.push(e.el.value)}e.addValue(t,!1)}},d.emit=function(t,d){let i=new e.CustomEvent(t,{bubbles:!0,detail:d});this.el.dispatchEvent(i)},d.originalElementFocus=function(){let e=this;if(!e.isDS){if(e.el.disabled)return;e.el.blur()}e.hdd.focus({preventScroll:!0}),e.hdd.classList.add("focus"),e.event(document,"add",{click:e.blur})},d.blurField=function(){this.hdd.classList.remove("focus")},d.nextOption=function(e){let t=Object.keys(this.hdd.options),d=e.length>0?t.indexOf(e[e.length-1]):-1;return d<t.length&&d++,d===t.length&&(d=0),t[d]},d.prevOption=function(e){let t=Object.keys(this.hdd.options),d=e.length>0?t.indexOf(e[0]):t.length;return d>=0&&d--,d<0&&(d=t.length-1),t[d]},d.keyboardNavigate=function(){let e,t=this,d=arguments[0];if(!t.el.disabled&&d&&d.keyCode)switch(d.preventDefault(),!0){case 40==d.keyCode&&"keydown"==d.type:t.hdd.classList.contains("active")?((t.hindex.length>0&&!t.multi||!d.shiftKey)&&t.clearClass("hover"),e=t.nextOption(t.hindex),t.hdd.options[e].classList.add("hover"),t.scroll(e,"down"),t.multi&&d.shiftKey?(t.hindex.push(e),t.opt.limitSelection>0&&(t.hindex=t.hindex.slice(-1*t.opt.limitSelection))):t.hindex[0]=e):1==t.opt.limitSelection?(e=t.nextOption(t.sindex),t.toggleValue([e],!0)):(t.hdd.classList.remove("focus"),t.open());break;case 38==d.keyCode&&"keydown"==d.type:if(t.hdd.classList.contains("active"))(t.hindex.length>0&&!t.multi||!d.shiftKey)&&t.clearClass("hover"),e=t.prevOption(t.hindex),t.hdd.options[e].classList.add("hover"),t.scroll(e,"up"),t.multi&&d.shiftKey?(t.hindex.push(e),t.opt.limitSelection>0&&(t.hindex=t.hindex.slice(-1*t.opt.limitSelection))):t.hindex[0]=e;else if(1==t.opt.limitSelection){let e=t.prevOption(t.sindex);t.toggleValue([e],!0)}else t.hdd.classList.remove("focus"),t.open();break;case 13==d.keyCode&&"keydown"==d.type:case 32==d.keyCode&&"keydown"==d.type:!1===t.hdd.classList.contains("active")?(t.hdd.classList.remove("focus"),t.open()):(t.hindex.length>0&&t.toggleValue(t.hindex,!0),t.closeSelect(!1),t.hdd.classList.add("focus"));break;case 27==d.keyCode&&"keydown"==d.type:t.hdd.classList.contains("active")&&t.closeSelect(!1),t.blurField();break;case 9==d.keyCode&&"keydown"==d.type:t.hdd.classList.contains("active")&&t.closeSelect(!1),t.blurField();let i,l,o=1*t.el.getAttribute("tabindex"),n=t.el.closest("form");if(null===n&&(n=document),null!=o&&""!=o)o+=1,i=n.querySelector('[tabindex="'+o+'"]');else if(n!==document)for(o in l=t.el,t.isDS&&(o=(l=Object.keys(t.hdd.options))[l.length-1],l=t.hdd.options[o].querySelector("input")),n.elements)if(n.elements[o]===l){do{o++}while(o<n.elements.length&&n.elements[o].classList.contains("hybridddin"));n.elements.length==o&&(o=0),i=n.elements[o].classList.contains("hybridddis")?n.elements[o].closest(".hybriddd-custom"):n.elements[o];break}if(null!=i)switch(!0){case i.classList.contains("hybriddd-custom"):i._hybriddd.originalElementFocus();break;case"text"===i.type:i.select();break;default:i.focus()}break;case 16==d.keyCode&&"keydown"==d.type:if(t.multi&&t.hdd.classList.contains("active")){let e=d.originalTarget;e||(e=d.target),e.classList.contains("hybriddd-option")||(e=e.closest(".hybriddd-option")),e&&(t.hindex=[e.querySelector("input").value]),t.listenForBulk||(t.event(t.hdd.ddlist,"add",{mouseenter:t.hover,mouseleave:t.hover,click:t.modClick,"hybrid-ddi-change":t.change}),t.listenForBulk=!0,t.listenModClick=!0)}break;case 16==d.keyCode&&"keyup"==d.type:t.listenForBulk&&(t.event(t.hdd.ddlist,"remove",{mouseenter:t.hover,mouseleave:t.hover,click:t.modClick,"hybrid-ddi-change":t.change}),t.listenForBulk=!1,t.listenModClick=!1);break;case 17==d.keyCode&&"keydown"==d.type:!t.listenModClick&&t.multi&&(t.event(t.hdd.ddlist,"add",{click:t.modClick,"hybrid-ddi-change":t.change}),t.listenModClick=!0);break;case 17==d.keyCode&&"keyup"==d.type:t.listenModClick&&(t.event(t.hdd.ddlist,"remove",{click:t.modClick,"hybrid-ddi-change":t.change}),t.listenModClick=!1)}},d.optionModClick=function(e){let t,d,i=this;if(e&&e.target){if(!e.ctrlKey&&!e.shiftKey)return i.listenModClick&&(i.event(i.hdd.ddlist,"remove",{click:i.modClick,"hybrid-ddi-change":i.change}),i.listenModClick=!1),void(i.listenForBulk&&(i.event(i.hdd.ddlist,"remove",{mouseenter:i.hover,mouseleave:i.hover}),i.listenForBulk=!1));(t=e.target.closest(".hybriddd-option"))&&((d=t.querySelector("input")).checked=!d.checked,d.dispatchEvent(new Event("hybrid-ddi-change",{bubbles:!0})),d.classList.add("mod-ctrl"))}},d.scroll=function(e,t="up"){let d=this,i=d.hdd.options[e].querySelector("label").getBoundingClientRect(),l=d.hdd.ddlist.getBoundingClientRect();if(i.top<l.top||i.bottom>l.bottom)switch(t){case"up":l.top>i.top?d.hdd.ddlist.scrollTop-=i.height:l.bottom<i.bottom&&(d.hdd.ddlist.scrollTop=i.bottom-l.bottom);break;case"down":l.bottom<i.bottom?d.hdd.ddlist.scrollTop+=i.height:l.top>i.top&&(d.hdd.ddlist.scrollTop=0)}},d.inputChange=function(){let e=this,t=arguments[0],d=[],i=!1;if(t&&t.target){if(i=t.target.classList.contains("mod-ctrl"),"change"==t.type&&i)return t.target.classList.remove("mod-ctrl"),!1;if(e.hindex.length>0&&(d=[...e.hindex]),t.target.checked&&""==t.target.value)i||e.removeValue([...e.sindex],!0);else if(e.opt.treeView&&(e.opt.limitSelection<0||e.opt.limitSelection>e.sindex.length)){let l,o,n=!0,s=t.target.closest(".hybriddd-option"),r=s.querySelectorAll("input");for(o of r.values())o.checked=t.target.checked,i||(t.target.checked?d.push(o.value):e.removeValue([o.value])),o.closest(".hybriddd-option").classList.remove("partial");for(;s;)o=s.querySelector("input"),n||o.checked||s.querySelectorAll("label input").length-s.querySelectorAll("label input:checked").length!=1||(o.checked=!0,d.push(o.value),s.classList.remove("partial")),r=s.querySelectorAll("input:checked"),l=s.querySelectorAll("input"),o.checked&&1==r.length&&l.length>1?(s.classList.remove("partial"),o.checked=!1,i||e.removeValue([o.value])):r.length>0&&l.length!=r.length?(s.classList.add("partial"),i||e.removeValue([o.value])):s.classList.remove("partial"),s=s.parentNode.closest(".hybriddd-option"),n=!1;i||e.addValue(d,!0)}else i||(d.push(t.target.value),t.target.checked?e.addValue(d,!0):e.removeValue(d,!0));switch(!0){case"hybrid-ddi-change"==t.type:case t.shiftKey&&1==t.shiftKey:break;default:e.closeSelect(!1)}}},d.toggleValue=function(e,t){let d=this;d.hdd.options[e[0]].querySelector("input").checked?d.removeValue(e,t):d.addValue(e,t)},d.addValue=function(e,t=!1){let d=this;switch(d.opt.limitSelection){case 1:d.sindex.length>0&&d.hdd.options[d.sindex[0]].classList.remove("active"),d.sindex=e;break;default:if(1==d.sindex.length&&0==d.sindex[0].length?(d.hdd.options[""].classList.remove("active"),d.hdd.options[""].querySelector("input").checked=!1,d.sindex=e):d.sindex=d.sindex.concat(e),d.opt.limitSelection>0){for(let e=d.opt.limitSelection;e<d.sindex.length;e++)d.hdd.options[d.sindex[e]].querySelector("input").checked=!1;d.sindex=d.sindex.slice(0,d.opt.limitSelection)}d.clearClass("hover"),d.hindex=[]}d.value={},d.sindex.forEach(e=>{d.value[e]=d.hdd.options[e].querySelector(".hybridddl").innerHTML,d.hdd.options[e].querySelector("input").checked=!0,d.hdd.options[e].classList.add("active")}),d.empty()&&d.reset(),d.isDS||d.updateOriginal(),d.hdd.selected.innerHTML=d.opt.selectedLabel(d.value),t&&d.emit("change")},d.removeValue=function(e,t=!1){let d,i=this;e.forEach(e=>{i.hdd.options[e].classList.remove("active"),i.hdd.options[e].querySelector("input").checked=!1,(d=i.sindex.indexOf(e))>=0&&(i.sindex.splice(d,1),delete i.value[e])}),0==i.sindex.length&&(i.hdd.options[""]?(i.sindex=[""],i.value={"":i.hdd.options[""].querySelector(".hybridddl").innerHTML},i.hdd.options[""].querySelector("input").checked=!0,i.hdd.options[""].classList.add("active")):i.value={"":i.opt.defaultText}),i.empty()&&i.reset(),i.isDS||i.updateOriginal(),i.hdd.selected.innerHTML=i.opt.selectedLabel(i.value),t&&i.emit("change")},d.updateOriginal=function(){let e=this;Object.keys(e.value).forEach(t=>{e.el.selectedIndex=-1,e.el.querySelector('option[value="'+t+'"]').selected=!0})},d.optionHover=function(){let e,t,d=this,i=arguments[0];if(i.shiftKey){if(t=i.target.classList.contains("hybriddd-option")?i.target:i.target.closest(".hybriddd-option")){switch(e=t.querySelector("input").value,i.type){case"mouseleave":d.event(d.hdd.ddlist,"remove",{mouseleave:d.hover}),e&&(d.hindex=[e]);break;case"mouseenter":d.hindex.includes(e)?(e=d.hindex[d.hindex.length-1],d.hindex=d.hindex.slice(0,-1)):e&&d.hindex.push(e),d.opt.limitSelection>0&&(d.hindex=d.hindex.slice(0,d.opt.limitSelection))}e&&!d.sindex.includes(e)&&d.hdd.options[e].classList.add("hover")}}else d.hindex.length>0&&(d.clearClass("hover"),d.hindex=[])},d.clearClass=function(e){let t=this;"string"==typeof e&&e.length>0&&t.hdd.querySelectorAll("."+e).forEach(t=>{t.classList.remove(e)})},d.openSelect=function(){let e=this,t=arguments[0];if(!e.el.disabled){if(t&&t.target){if(t.target.classList.contains("hybriddd-options")||t.target.closest(".hybriddd-options"))return;t.stopPropagation(),e.emit("hybrid-dd-"+t.type)}e.hdd.classList.contains("active")?e.closeSelect():(e.hdd.listwrap.style.setProperty("--hybriddd-top",e.hdd.offsetHeight+"px"),e.hdd.classList.add("active"),e.hdd.ddlist.style["min-width"]||(e.hdd.ddlist.style["min-width"]=e.hdd.ddlist.offsetWidth+12+"px"),e.hdd.listwrap.style.height||(e.hdd.listwrap.style.height=e.hdd.ddlist.offsetHeight+"px",e.hdd.listwrap.style.width="100%"),e.event(document,"add",{click:e.close}),e.event(e.hdd,"add",{keyup:e.keyNav}),e.event(document,"add",{"hybrid-dd-click":e.close}))}},d.closeSelect=function(e){let t=this,d=arguments[0],i=arguments[1];if(!(d&&d.target&&d.target.classList.contains("hybriddd-option"))){if(i){if(i.target.isSameNode(t.el))return;if(t.multi&&(i.ctrlKey||i.shiftKey))return;if(i.target.parentNode.classList&&i.target.parentNode.classList.contains("hybriddd-group"))return;if(i.target.closest(".hybriddd-option"))return}t.hdd.classList.remove("active"),t.clearClass("hover"),t.hindex=[],t.event(document,"remove",{click:t.close}),t.event(document,"remove",{"hybrid-dd-click":t.close}),t.event(t.hdd,"remove",{keyup:t.keyNav}),t.listenForBulk&&(t.event(t.hdd.ddlist,"remove",{mouseenter:t.hover}),t.listenForBulk=!1),e&&t.blur()}},t});
>>>>>>> e1ad2670257b80ebfdc0aac2db0c2ace6b48fc38
